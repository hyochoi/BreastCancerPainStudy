---
title: "PCM data analysis"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    fig_width: 12
    fig_height: 6
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,autodeep=TRUE,cache.comments=FALSE,warning=FALSE,message=FALSE,cache.lazy=FALSE)
```

```{r,echo=FALSE}
library(openxlsx)
library(RPlotRNAseq)
library(SCISSOR)
library(lattice)
library(quantreg)
library(ggplot2)
library(pscl)
library(boot)
library(MASS)
library(dplyr)

# today = Sys.Date()
dataDir = "./rawData/"
```

# Data files

*_Raw data files._*

* PatientVars_zip.csv   
* R21_Sample_wDxDate.xlsx        
* joined_zipcode.xlsx    
* Copy.xlsx (Occupation, Primary payer, marital status)      
* pcm.xlsx     

*_Manipulated data files._*

* PatientVars_zip.csv -> PatientVars_zip_neededVars.xlsx   
    - Only needed variables (profile_key, dx_date_use, Marital_Status_at_DX_Desc, ssn_wcc_num, zip, accession_no, state, race_NIH, race_simple, stage_merged, stage_simple, gender, age_at_dx, age_binary, first_chemo, first_surgery) were selected.    
    - first_chemo & first_surgery variables were reformatted as "Date" to be acceptable by R.     

* R21_Sample_wDxDate.xlsx -> newDxDate.xlsx    
    - Cleaned datasets with new dx_date (initial diagnosis date) was released (3/12/2020) - R21_Sample_wDxDate.    
    - newDxDate file is a copy of R21_Sample_wDxDate file to modify the original variables for the downstream analysis. dx_date was renamed to dx_date_use (which is the same as in PatientVars_zip3.xlsx).   
    - All patients in PatientVars_zip3 file are also recorded in newDxDate file.    
    - 174 patients are missing in dx_date_use.   

* PatientVars_zip3.xlsx + newDxDate.xlsx -> patients_file_new.xlsx   

* joined_zipcode.xlsx -> poverty_file_new.xlsx   
    - Poverty, vacancy, walkability, and unemployment were taken as group mean by zip 





* Re-merge the datasets based on the new dx_date_use (newDxDate file).    

original dx_date_use has been replaced by the new dx_date_use.   


## In PatientVars_zip3, replace the dx_date_use variable by the new dx_date_use in newDxDate.xlsx.  

```{r,echo=FALSE,eval=FALSE}
patients_file = read.xlsx(xlsxFile=paste0(dataDir,"PatientVars_zip_neededVars.xlsx"),sheet=1,detectDates=TRUE)
patients_file$ssn_wcc_num=as.character(patients_file$ssn_wcc_num)
# dim(patients_file)
# head(patients_file)
# length(unique(patients_file$profile_key))

newDxDate_file = read.xlsx(xlsxFile=paste0(dataDir,"newDxDate.xlsx"),sheet=1,detectDates=TRUE)
# dim(newDxDate_file)
# head(newDxDate_file)
# length(unique(newDxDate_file$profile_key))

## Collapse with the newDxDate and PatientVars_zip3 -> patients_file2
patients_file2 = merge(x=patients_file,y=newDxDate_file,by="profile_key")
# head(patients_file2)
# dim(patients_file2)

cat(paste("Number of different dx_date_use =",length(which(! patients_file2$dx_date_use.x==patients_file2$dx_date_use.y))),"\n")
cat(paste("Number of NA's in dx_date_use =",length(which(is.na(patients_file2$dx_date_use.y)))),"\n")

## Make new PatientVars file. 
# patients_file3 = patients_file2[,c(1,15,3,19,5:10,30,12:14,22:29)]
patients_nvars = dim(patients_file)[2]
patients_file3 = patients_file2[,c(1,(patients_nvars+1),3:patients_nvars)] # Should be carefully chosen!
# head(patients_file3)
colnames(patients_file3)[2] = "dx_date_use"
colnames(patients_file3)[4] = "ssn_wcc_num"

# first_chemo & first_surgery variable class - should be fixed for strange dates
class(patients_file3$first_chemo)
class(patients_file3$first_surgery)
patients_file3$first_chemo = as.Date(patients_file3$first_chemo)
patients_file3$first_surgery = as.Date(patients_file3$first_surgery)
class(patients_file3$first_chemo)
class(patients_file3$first_surgery)
patients_file3$first_chemo[which(grepl(pattern="[****]",patients_file3$first_chemo)==T)] = NA
patients_file3$first_surgery[which(grepl(pattern="[****]",patients_file3$first_surgery)==T)] = NA

## Final dataset
patients_file = patients_file3
head(patients_file)
# write.xlsx(x=patients_file,file=paste0(dataDir,"patients_file_new.xlsx"))
```


## Poverty data 

* "joined_zipcode" file merged to get data about poverty, vacancy, unemployment levels for more zip codes.   
    - The main difference from the 'PCM_preprocessing' file is that the zip_poverty file (POVERTY, VACANCY, WALKABILITY, UNEMPLOYMENT) is replaced by "joined_zipcode" file.   
    - All zip codes in "zip_poverty" file are included in "joined_zipcode" file.   
    - And the statistics are strongly matched to each other.    
    - Good for the replacement.   
    
```{r,echo=FALSE,eval=FALSE}
## New "joined_zipcode" file
joined_zipcode_file=read.xlsx(xlsxFile=paste0(dataDir,"joined_zipcode.xlsx"),sheet=1,colNames=T,
                              skipEmptyCols=F,skipEmptyRows=F)
# dim(joined_zipcode_file)
# head(joined_zipcode_file)
# sapply(joined_zipcode_file,class)
joined_zipcode_file$zip = as.character(joined_zipcode_file$zip)

# head(joined_zipcode_file[,c(2,4,11,12,13,14,27)])
joined_zipcode = joined_zipcode_file[,c(2,4,11,12,13,14,27)]

# table(joined_zipcode$zip)
joined_poverty_mean=aggregate(. ~ zip, joined_zipcode, mean)
colnames(joined_poverty_mean) = c("ZIP_CODE_1","Population2010","CANCER","POVERTY","VACANCY","WALKABILITY","UNEMPLOYMENT")

poverty_mean=joined_poverty_mean[,c(1,4:7)]
head(poverty_mean)
dim(poverty_mean)
# write.xlsx(x=poverty_mean,file=paste0(dataDir,"poverty_file_new.xlsx"))
```

* Poverty data (from "joined_zipcode")

    - For poverty variable, group mean used for each zip code. -> poverty_file_new.xlsx        
    - Only 43 zip codes are documented in poverty file. On the other hand, there are 165 zip codes (TN) in Patients file. This will produce too many missing values for the poverty variable.  

# Merge datasets

```{r,echo=FALSE}
patients_file = read.xlsx(xlsxFile=paste0(dataDir,"patients_file_new.xlsx"),sheet=1,detectDates=TRUE)
class(patients_file$first_chemo)
patients_file$first_chemo = as.Date(patients_file$first_chemo)
class(patients_file$first_chemo)

poverty_file = read.xlsx(xlsxFile=paste0(dataDir,"poverty_file_new.xlsx"),sheet=1,detectDates=TRUE)

copy_file1=read.xlsx(xlsxFile=paste0(dataDir,"Copy.xlsx"),sheet=1,detectDates=TRUE)
copy_file2=read.xlsx(xlsxFile=paste0(dataDir,"Copy.xlsx"),sheet=2,detectDates=TRUE)
copy_file3=read.xlsx(xlsxFile=paste0(dataDir,"Copy.xlsx"),sheet=3,detectDates=TRUE)
# copy_file=rbind(copy_file1,copy_file2,copy_file3)[,c(1,5,13,17,18,23,24,25,26,27,57,58)]

copy_file0 = rbind(copy_file1,copy_file2,copy_file3)
copy_file <-
  copy_file0 %>%
  select("Accession.Number","Social.Security.Number","Vital.Status-Desc",
         "Text.-.Usual.Occupation","Text.-.Usual.Industry",
         "Date.of.Initial.Diagnosis","Age.at.Diagnosis","Primary.Payer.at.DX-Desc",
         "Marital.Status.at.DX-Desc","Tobacco.History-Desc",
         "Date.of.First.Surgery","Cancer.Status-Desc","Date.1st.Recurrence",
         "Postal.Code.at.Diagnosis","State.at.Diagnosis-Desc",
         "Primary.Site-Desc","Histo/Behavior.ICD-O-3-Desc","Tumor.Size-MM",
         "ER","PR","HER2","RT.Site-Desc","Type.1st.Recurrence-Desc")

copy_file$Social.Security.Number=as.character(as.numeric(copy_file$Social.Security.Number))

pcm_file=read.xlsx(xlsxFile=paste0(dataDir,"pcm.xlsx"),sheet=1,detectDates=TRUE)

pcm_file[which(pcm_file$profile_key=="1665"),]
patients_file[which(patients_file$profile_key=="1665"),]
```

* The cohorts of PCM file and Patients file are equal.   

```{r,echo=FALSE}
pcm_profile_key=sort(unique(pcm_file$profile_key))
patients_profile_key=sort(unique(patients_file$profile_key))
N = length(patients_profile_key)

length(which(! pcm_profile_key %in% patients_profile_key))
length(which(! patients_profile_key %in% pcm_profile_key))
cat(paste("\t Total number of samples =",N),"\n")
```


```{r,echo=FALSE}
profile_key = patients_profile_key
## PatientVars_zip file
sortbydate=function(x) {
  temp_rows=which(patients_file$profile_key==x)
  if (sum(is.na(patients_file$dx_date_use[temp_rows]))==length(temp_rows)) {
    temp_rows[1]
  } else {
    temp_rows[which(patients_file$dx_date_use[temp_rows]==min(patients_file$dx_date_use[temp_rows],na.rm=TRUE))][1]
  }
}
patients_rows=apply(matrix(profile_key,ncol=1),1,FUN=sortbydate)
patients_sort=patients_file[patients_rows,]
# head(patients_sort)
# tail(patients_sort)
cat(paste("\t Number of NA's in dx_date_use in PatientsVar =",sum(is.na(patients_sort$dx_date_use))),"\n")

```

patients_file + copy_file + poverty_file  

* Merge patients file and copy file by SSN and then merge it with poverty file by ZIP

```{r,echo=FALSE}
m1 = merge(x=patients_sort,y=copy_file,by.x="ssn_wcc_num",by.y="Social.Security.Number",all=T)
dim(m1)
m1 = m1[order(m1$profile_key),] # Sort by profile key
m2 = m1[which(m1$ssn_wcc_num %in% patients_sort$ssn_wcc_num),]
dim(m2)
mergedData = merge(m1,poverty_file,by.x="zip",by.y="ZIP_CODE_1",all=T)
mergedData = mergedData[order(mergedData$profile_key),]
dim(mergedData)
# mergedData=merge(pcm_sort,m2,by="profile_key",all=T)
```

```{r,echo=FALSE,eval=FALSE}
length(unique(copy_file$Social.Security.Number))

length(unique(m1$profile_key))
length(unique(mergedData$zip))
length(unique(mergedData$profile_key))
dim(mergedData)
```

## Merging datasets naively gives many duplicates and this should be addressed.


1. Delete the perfect duplicates, i.e. the rows with the exactly same information.  (Number of rows: 11025 $\rightarrow$ 7689)

N = 3836

```{r}
mergedData_uniq1 = distinct(mergedData)
dim(mergedData_uniq1)
length(unique(mergedData_uniq1$profile_key))
```

2. Remove redundant samples. 
    - States other than TN (7714 $\rightarrow$ 2673)      
    - Profile key: (3836 -> 2628)   

```{r,echo=FALSE}
cat(paste("All distinct states =",paste(unique(mergedData_uniq1$state),collapse=",")),"\n")
```

```{r}
mergedData_uniq2 = mergedData_uniq1[which(mergedData_uniq1$state=="TN"),]
dim(mergedData_uniq2)
length(unique(mergedData_uniq2$profile_key))
length(unique(mergedData_uniq2$zip))
```

3. Other duplicates using profile_key  

    - There are 43 duplicated profile keys in the merged data set.     
    - e.g. profile key==90006  

```{r,echo=FALSE}
dup_samples=which(duplicated(mergedData_uniq2$profile_key)==1)
length(mergedData_uniq2$profile_key[dup_samples])
length(unique(mergedData_uniq2$profile_key[dup_samples]))

mergedData_uniq2[which(mergedData_uniq2$profile_key==mergedData_uniq2$profile_key[dup_samples[1]]),]

cat(paste("\t ",length(dup_samples)," duplicated samples =",paste(mergedData_uniq2$profile_key[dup_samples],collapse=",")),"\n")
```

4. Remove the 45 duplicates (2628 -> 2584)

```{r}
profile.split = split(x=which(mergedData_uniq2$profile_key %in% mergedData_uniq2$profile_key[dup_samples]),
                      f=mergedData_uniq2$profile_key[which(mergedData_uniq2$profile_key %in% mergedData_uniq2$profile_key[dup_samples])])

discard_dup = function(x) {
  x[-which.min(apply(mergedData_uniq2[x,],1,function(x) length(which(is.na(x)==T))))]
}
discard_ids = do.call("c",sapply(profile.split,discard_dup))
length(discard_ids)

mergedData_uniq3 = mergedData_uniq2[-discard_ids,]

dim(mergedData_uniq3)
length(unique(mergedData_uniq3$profile_key))
length(unique(mergedData_uniq3$zip))

```


```{r,echo=FALSE}
N=length(unique(mergedData_uniq3$profile_key))
cat(paste("\t Total number of unique samples in the merged data (N) =",N),"\n")
```


```{r,eval=FALSE}
# today = "2020-07-15"
# write.xlsx(x=mergedData_uniq3,file=paste0(dataDir,"PatientsData_merged_",today,"_raw.xlsx"))
```


## Further treatment for PatientsData file. 

* Variable names changed   
* Remove duplicated variable    
* missing -> unknown   
* data structure     
    - NA -> Unknown
    - experimental variables: 
    - control variables: age, stage, primary site, 


```{r,echo=FALSE}
merged_file=read.xlsx(xlsxFile=paste0(dataDir,"PatientsData_merged_2020-07-15_raw.xlsx"),sheet=1,detectDates=TRUE)

merged_file$zip = sapply(as.character(merged_file$zip),FUN=function(x){paste(strsplit(x,split="")[[1]][1:5],collapse="")})

colnames(merged_file)[which(colnames(merged_file)=="Marital_Status_at_DX_Desc")] = "Marital_Status_at_DX"
colnames(merged_file)[which(colnames(merged_file)=="Vital.Status-Desc")] = "Vital.Status"
colnames(merged_file)[which(colnames(merged_file)=="Text.-.Usual.Occupation")] = "Usual.Occupation"
colnames(merged_file)[which(colnames(merged_file)=="Text.-.Usual.Industry")] = "Usual.Industry"
colnames(merged_file)[which(colnames(merged_file)=="Primary.Site-Desc")] = "Primary.Site"
colnames(merged_file)[which(colnames(merged_file)=="Primary.Payer.at.DX-Desc")] = "Primary.Payer.at.DX"
colnames(merged_file)[which(colnames(merged_file)=="Marital.Status.at.DX-Desc")] = "Marital.Status.at.DX"
colnames(merged_file)[which(colnames(merged_file)=="Tobacco.History-Desc")] = "Tobacco.History"
colnames(merged_file)[which(colnames(merged_file)=="Tumor.Size-MM")] = "Tumor.Size.MM"
colnames(merged_file)[which(colnames(merged_file)=="Cancer.Status-Desc")] = "Cancer.Status"
colnames(merged_file)[which(colnames(merged_file)=="State.at.Diagnosis-Desc")] = "State.at.Diagnosis"
colnames(merged_file)[which(colnames(merged_file)=="RT.Site-Desc")] = "RT.Site"
colnames(merged_file)[which(grepl(pattern="Type.1st",colnames(merged_file))==T)] = "Recurrence"
colnames(merged_file)[which(grepl(pattern="Behavior",colnames(merged_file))==T)] = "Histology"
colnames(merged_file)[which(grepl(pattern="metasta",colnames(merged_file))==T)] = "Metastasis"

merged_file = merged_file[,-which(colnames(merged_file)=="Marital.Status.at.DX")]

cat(paste("Number of missing values for each variable:"),"\n")
for (jc in 1:dim(merged_file)[2]) {
  cat(paste(jc,"|",colnames(merged_file)[jc],"|",length(which(is.na(merged_file[,jc])==1))),"\n")
}

## missing values
hist(apply(merged_file,1,FUN=function(x){sum(is.na(x))}))
# write.xlsx(x=merged_file[sample1,c(3,4,32:35)],file=paste0(dataDir,"PCM_merged_POVERTY_nomissing.xlsx"))
```

* Change the values for each variable to favoriable format:

```{r,echo=FALSE}
# Cancer status
merged_file$Cancer.Status[which(is.na(merged_file$Cancer.Status)==1)] = "Unknown"
merged_file$Cancer.Status[which(grepl(pattern="Unknown whether",x=merged_file$Cancer.Status)==1)] = "Unknown"
merged_file$Cancer.Status[which(grepl(pattern="No evidence",x=merged_file$Cancer.Status)==1)] = "No_evidence"
merged_file$Cancer.Status[which(grepl(pattern="Evidence of",x=merged_file$Cancer.Status)==1)] = "Evidence"
table(merged_file$Cancer.Status)  

# Cancer.Status.n = rep(0,dim(merged_file)[1])
# Cancer.Status.n[which(merged_file$Cancer.Status=="Unknown")] = 2
# Cancer.Status.n[which(merged_file$Cancer.Status=="Evidence")] = 1
Cancer.Status.f = factor(merged_file$Cancer.Status)
Cancer.Status.f = relevel(Cancer.Status.f,"No_evidence")
table(Cancer.Status.f)

## Cancer stage
stage.f = factor(merged_file$stage_simple)
stage.f = relevel(stage.f,"1")
table(stage.f)

## Age
age.f = factor(merged_file$age_binary)
table(age.f)

## Race
table(merged_file$race_simple)
race.f = factor(merged_file$race_simple)
race.f = relevel(race.f,"White")
table(race.f)

## Marital status
merged_file$Marital_Status_at_DX[which(is.na(merged_file$Marital_Status_at_DX)==1)] = "Unknown"
merged_file$Marital_Status_at_DX[which(merged_file$Marital_Status_at_DX=="Married (including common")] = "Married"
merged_file$Marital_Status_at_DX[which(merged_file$Marital_Status_at_DX=="Single (never married)")] = "Single"
merged_file$Marital_Status_at_DX[which(merged_file$Marital_Status_at_DX=="Unmarried or Domestic Par")] = "Single"
merged_file$Marital_Status_at_DX[which(merged_file$Marital_Status_at_DX=="Separated")] = "Divorced"

marital.status.f = factor(merged_file$Marital_Status_at_DX)
marital.status.f = relevel(marital.status.f,"Married")
table(marital.status.f)

## Usual occupation
merged_file$Usual.Occupation[which(grepl(pattern="retired",x=merged_file$Usual.Occupation,ignore.case=T)==1)] = "Retired"

merged_file$Usual.Occupation[which(grepl(pattern="disabled",x=merged_file$Usual.Occupation,ignore.case=T)==1)] = "Disabled"

merged_file$Usual.Occupation[which(grepl(pattern="unemployed",x=merged_file$Usual.Occupation,ignore.case=T)==1)] = "Unemployed"
merged_file$Usual.Occupation[which(grepl(pattern="not employed",x=merged_file$Usual.Occupation,ignore.case=T)==1)] = "Unemployed"

merged_file$Usual.Occupation[which(grepl(pattern="self",x=merged_file$Usual.Occupation,ignore.case=T)==1)] = "Self_employed"

merged_file$Usual.Occupation[which(grepl(pattern="unknown",x=merged_file$Usual.Occupation,ignore.case=T)==1)] = "Unknown"
merged_file$Usual.Occupation[which(grepl(pattern="none",x=merged_file$Usual.Occupation,ignore.case=T)==1)] = "Unknown"
merged_file$Usual.Occupation[which(grepl(pattern="Not listed",x=merged_file$Usual.Occupation,ignore.case=T)==1)] = "Unknown"
merged_file$Usual.Occupation[which(grepl(pattern="Not employed",x=merged_file$Usual.Occupation,ignore.case=T)==1)] = "Unknown"


merged_file$Usual.Occupation[which(is.na(merged_file$Usual.Occupation)==1)] = "Unknown"

merged_file$Usual.Occupation[which(! merged_file$Usual.Occupation %in% c("Retired","Disabled","Unknown","Unemployed","Self-employed"))] = "Employed"

# length(which(! merged_file$Usual.Occupation %in% c("Retired","Disabled","Unknown","Unemployed","Self-employed")))

Usual.Occupation.f = factor(merged_file$Usual.Occupation)
Usual.Occupation.f = relevel(Usual.Occupation.f,"Employed")
table(Usual.Occupation.f)

## Primary Payer
merged_file$Primary.Payer.at.DX[which(grepl(pattern="tricare",x=merged_file$Primary.Payer.at.DX,ignore.case=T)==1)] = "Medicaid"
merged_file$Primary.Payer.at.DX[which(grepl(pattern="medicare",x=merged_file$Primary.Payer.at.DX,ignore.case=T)==1)] = "Medicaid"
merged_file$Primary.Payer.at.DX[which(grepl(pattern="medicaid",x=merged_file$Primary.Payer.at.DX,ignore.case=T)==1)] = "Medicaid"
merged_file$Primary.Payer.at.DX[which(grepl(pattern="private",x=merged_file$Primary.Payer.at.DX,ignore.case=T)==1)] = "Private"
merged_file$Primary.Payer.at.DX[which(grepl(pattern="unknown",x=merged_file$Primary.Payer.at.DX,ignore.case=T)==1)] = "Unknown"
merged_file$Primary.Payer.at.DX[which(grepl(pattern="not",x=merged_file$Primary.Payer.at.DX,ignore.case=T)==1)] = "Unknown"
merged_file$Primary.Payer.at.DX[which(is.na(merged_file$Primary.Payer.at.DX)==1)] = "Unknown"

merged_file$Primary.Payer.at.DX[which(! merged_file$Primary.Payer.at.DX %in% c("Medicaid","Unknown","Private"))] = "Insurance"

Primary.Payer.f = factor(merged_file$Primary.Payer.at.DX)
Primary.Payer.f = relevel(Primary.Payer.f,"Private")
table(Primary.Payer.f)

## Merge factor variables to the original data set
merged_file$Cancer.Status.f = Cancer.Status.f
merged_file$stage.f = stage.f
merged_file$age.f = age.f
merged_file$race.f = race.f
merged_file$marital.status.f = marital.status.f
merged_file$Usual.Occupation.f = Usual.Occupation.f
merged_file$Primary.Payer.f = Primary.Payer.f

table(merged_file$Tobacco.History)
merged_file$Tobacco.History[is.na(merged_file$Tobacco.History)] = "Unknown"
merged_file$Tobacco.History[grepl(pattern="Never",merged_file$Tobacco.History)] = "Never"
merged_file$Tobacco.History[grepl(pattern="Smoke|smoke",merged_file$Tobacco.History)] = "Smoked"
merged_file$Tobacco.History[grepl(pattern="positive",merged_file$Tobacco.History)] = "Smoked"
merged_file$Tobacco.History[grepl(pattern="Unknown",merged_file$Tobacco.History)] = "Unknown"
merged_file$Tobacco.History[grepl(pattern="    ",merged_file$Tobacco.History)] = "Unknown"
table(merged_file$Tobacco.History)
merged_file$Tobacco.History = factor(merged_file$Tobacco.History,
                             levels=c("Never","Smoked","Unknown"))

# table(merged_file$Histology)
merged_file$Histology[which(is.na(merged_file$Histology)==T)] = "Unknown"
merged_file$Histology[(grepl(pattern="duct",merged_file$Histology,ignore.case=T) & grepl(pattern="lob",merged_file$Histology,ignore.case=T))] = "ductal"
merged_file$Histology[grepl(pattern="duct",merged_file$Histology,ignore.case=T)] = "ductal"
merged_file$Histology[grepl(pattern="lob",merged_file$Histology,ignore.case=T)] = "lobular"
# table(merged_file$Histology[!grepl(pattern="lobular|ductal",merged_file$Histology,ignore.case=T)])
merged_file$Histology[!grepl(pattern="lobular|ductal|Unknown",merged_file$Histology,ignore.case=T)] = "Other"
table(merged_file$Histology)

table(merged_file$HER2)
merged_file$HER2[which(is.na(merged_file$HER2)==T)] = "Unknown"
merged_file$HER2[grepl(pattern="Negative",merged_file$HER2,ignore.case=T)] = "Negative.Normal"
merged_file$HER2[grepl(pattern="Positive",merged_file$HER2,ignore.case=T)] = "Positive.Elevated"
merged_file$HER2[grepl(pattern="not",merged_file$HER2,ignore.case=T)] = "Test.not.done"

table(merged_file$ER)
merged_file$ER[which(is.na(merged_file$ER)==T)] = "Unknown"
merged_file$ER[grepl(pattern="Negative",merged_file$ER,ignore.case=T)] = "Negative.Normal"
merged_file$ER[grepl(pattern="Positive",merged_file$ER,ignore.case=T)] = "Positive.Elevated"
merged_file$ER[grepl(pattern="not",merged_file$ER,ignore.case=T)] = "Test.not.done"

table(merged_file$PR)
merged_file$PR[which(is.na(merged_file$PR)==T)] = "Unknown"
merged_file$PR[grepl(pattern="Negative",merged_file$PR,ignore.case=T)] = "Negative.Normal"
merged_file$PR[grepl(pattern="Positive",merged_file$PR,ignore.case=T)] = "Positive.Elevated"
merged_file$PR[grepl(pattern="not",merged_file$PR,ignore.case=T)] = "Test.not.done"

table(merged_file$Recurrence)
merged_file$Recurrence[which(is.na(merged_file$Recurrence)==T)] = "Unknown"
merged_file$Recurrence[grepl(pattern="never been disease-free",merged_file$Recurrence,ignore.case=T)] = "Recurrence"
merged_file$Recurrence[grepl(pattern="ever disease-free",merged_file$Recurrence,ignore.case=T)] = "Recurrence"
merged_file$Recurrence[grepl(pattern="disease-free",merged_file$Recurrence,ignore.case=T)] = "disease-free"
merged_file$Recurrence[!grepl(pattern="disease-free|Unknown",merged_file$Recurrence,ignore.case=T)] = "Recurrence"
merged_file$Recurrence[grepl(pattern="unknown",merged_file$Recurrence,ignore.case=T)] = "Unknown"

merged_file$Primary.Site[which(is.na(merged_file$Primary.Site)==T)] = "Unknown"
merged_file$Primary.Site.1 = merged_file$Primary.Site.2 = merged_file$Primary.Site
merged_file$Primary.Site.1[grepl(pattern="lower",merged_file$Primary.Site.1,ignore.case=T)] = "Lower"
merged_file$Primary.Site.1[grepl(pattern="upper",merged_file$Primary.Site.1,ignore.case=T)] = "Upper"
merged_file$Primary.Site.1[grepl(pattern="central",merged_file$Primary.Site.1,ignore.case=T)] = "Central"
merged_file$Primary.Site.1[!grepl(pattern="upper|central|lower|unknown",merged_file$Primary.Site.1,ignore.case=T)] = "Unknown"

table(merged_file$Primary.Site.2)
merged_file$Primary.Site.2[grepl(pattern="inn",merged_file$Primary.Site.2,ignore.case=T)] = "Inner"
merged_file$Primary.Site.2[grepl(pattern="out",merged_file$Primary.Site.2,ignore.case=T)] = "Outer"
merged_file$Primary.Site.2[grepl(pattern="mid",merged_file$Primary.Site.2,ignore.case=T)] = "Midline"
merged_file$Primary.Site.2[grepl(pattern="over",merged_file$Primary.Site.2,ignore.case=T)] = "Overlapping"
merged_file$Primary.Site.2[!grepl(pattern="inner|midline|outer|unknown|overlapping",merged_file$Primary.Site.2,ignore.case=T)] = "Unknown"

table(merged_file$Metastasis)
merged_file$Metastasis[which(is.na(merged_file$Metastasis)==T)] = "No"
merged_file$Metastasis[which(merged_file$Metastasis=="Y")] = "Yes"
head(merged_file)
```


## Save the merged data

```{r,eval=FALSE}
# write.xlsx(x=merged_file,file=paste0(dataDir,"PatientsData_merged_",today,".xlsx"))
```


## Descriptive table

* samples with no missing values (n=685)    
* zip code with at least 5 samples (n=883)

```{r}
sample0 = which(apply(merged_file,1,FUN=function(x){sum(is.na(x))})==0) # samples with no missing values
cat(paste("Number of samples with no missing =",length(sample0)),"\n")

merged_file0 = merged_file[sample0,]
dim(merged_file0)
table(merged_file0$zip)
zipcode0 = sort(unique(merged_file0$zip))
# zipcode0 = sort(names(table(merged_file0$zip)[which(table(merged_file0$zip)>5)]))
# merged_file0 = merged_file0[which(merged_file0$zip %in% zipcode),]
# table(merged_file0$zip)


```

* samples with no missing values in POVERTY (n=1410)

```{r}
sample1 = which(apply(merged_file[,c(3,4,31:34)],1,FUN=function(x){sum(is.na(x))})==0) # samples with no missing values in POVERTY
cat(paste("Number of samples with no missing =",length(sample1)),"\n")

merged_file1 = merged_file[sample1,]
dim(merged_file1)
table(merged_file1$zip)
zipcode1 = sort(unique(merged_file1$zip))
# zipcode1 = sort(names(table(merged_file1$zip)[which(table(merged_file1$zip)>5)]))
# merged_file1 = merged_file1[which(merged_file1$zip %in% zipcode1),]
# table(merged_file1$zip)
```




# PCM data (pain perception)

Goal. PCM + dx_date_use + first_chemo + first_surgery

* Remove duplicates from PCM file (N=3835)

```{r}
rm(pcm_file)
pcm_file_original = read.xlsx(xlsxFile=paste0(dataDir,"pcm.xlsx"),sheet=1,detectDates=TRUE)
pcm_file = pcm_file_original
dim(pcm_file)
length(unique(pcm_file$profile_key))

pcm_uniq1 = distinct(pcm_file)
dim(pcm_uniq1)
length(unique(pcm_uniq1$profile_key))
```

* Remove samples that are not in PatientVar profile

```{r,echo=FALSE}
mergedData=read.xlsx(xlsxFile=paste0(dataDir,"PatientsData_merged_2020-07-15.xlsx"),sheet=1,detectDates=TRUE)

cat(paste("Number of patients in PCM profile but not in PatientVar profile = ",length(which(! unique(pcm_uniq1$profile_key) %in% mergedData$profile_key))),"\n")
cat(paste("Number of patients in PatientVar profile but not in PCM profile = ",length(which(! mergedData$profile_key %in% unique(pcm_uniq1$profile_key)))),"\n")

pcm_uniq2 = pcm_uniq1[which(pcm_uniq1$profile_key %in% mergedData$profile_key),]
dim(pcm_uniq2)
length(unique(pcm_uniq2$profile_key))
```

* Remove NAs from PCM file

```{r,echo=FALSE}
length(which(is.na(pcm_uniq2$a_CCMA06)))
pcm_uniq3 = pcm_uniq2[which(! is.na(pcm_uniq2$a_CCMA06)),]
dim(pcm_uniq3)
length(unique(pcm_uniq3$profile_key))

cat(paste("Number of patients in PatientVar profile but not in PCM profile = ",length(which(! mergedData$profile_key %in% unique(pcm_uniq3$profile_key)))),"\n")

## Final
pcm_file = pcm_uniq3
profile_key = mergedData$profile_key
```

* Put dx_date_use to the closest survey date in PCM file.   

```{r,echo=FALSE}
dx_date = as.Date(rep(NA,dim(pcm_file)[1]))
dx_diff_days = rep(NA,dim(pcm_file)[1])

dx_date_na_num = 0
for (i in 1:length(unique(pcm_file$profile_key))) {
  x = unique(pcm_file$profile_key)[i]
  temp_rows=which(pcm_file$profile_key==x)
  # pcm_file[temp_rows,]
  if (! is.na(mergedData$dx_date_use[which(mergedData$profile_key==x)])) {
    diff_days0=pcm_file$SURVEY_DATE[temp_rows]-mergedData$dx_date_use[which(mergedData$profile_key==x)]
    dx_diff_days[temp_rows] = diff_days0
    sel_row = temp_rows[which(abs(diff_days0)==min(abs(diff_days0),na.rm=TRUE))][1]
    dx_date[sel_row] = mergedData$dx_date_use[which(mergedData$profile_key==x)]
  } else {
    dx_date_na_num = dx_date_na_num + 1    
  }
  # cat(paste(i),"\n")
}
pcm_final = cbind(pcm_file,dx_date,dx_diff_days)

cat(paste("Number of patients in PCM with dx_date not available =",dx_date_na_num),"\n")
cat(paste("Number of patients in PCM with dx_date available =",length(which(!is.na(pcm_final$dx_date)))),"\n")
rm(diff_days0)
```

* Put first_chemo to the closest survey date in PCM file.

```{r,echo=FALSE}
first_chemo_date = as.Date(rep(NA,dim(pcm_file)[1]))
chemo_diff_days = rep(NA,dim(pcm_file)[1])

first_chemo_na_num = 0
for (i in 1:length(unique(pcm_file$profile_key))) {
  x = unique(pcm_file$profile_key)[i]
  # x = "112907"
  temp_rows=which(pcm_file$profile_key==x)
  # pcm_file[temp_rows,]
  if (! is.na(mergedData$first_chemo[which(mergedData$profile_key==x)])) {
    diff_days0=pcm_file$SURVEY_DATE[temp_rows]-as.Date(mergedData$first_chemo[which(mergedData$profile_key==x)])
    chemo_diff_days[temp_rows] = diff_days0
    sel_row = temp_rows[which(abs(diff_days0)==min(abs(diff_days0),na.rm=TRUE))][1]
    first_chemo_date[sel_row] = mergedData$first_chemo[which(mergedData$profile_key==x)]
  } else {
    first_chemo_na_num = first_chemo_na_num + 1    
  }
  # cat(paste(i),"\n")
}
pcm_final = cbind(pcm_final,first_chemo_date,chemo_diff_days)

cat(paste("Number of patients in PCM with first_chemo not available =",first_chemo_na_num),"\n")
cat(paste("Number of patients in PCM with first_chemo available =",length(which(!is.na(pcm_final$first_chemo_date)))),"\n")

```

* Put first_surgery to the closest survey date in PCM file.

```{r,echo=FALSE}
first_surgery_date = as.Date(rep(NA,dim(pcm_file)[1]))
surgery_diff_days = rep(NA,dim(pcm_file)[1])

first_surgery_na_num = 0
for (i in 1:length(unique(pcm_file$profile_key))) {
  x = unique(pcm_file$profile_key)[i]
  # x = "112907"
  temp_rows=which(pcm_file$profile_key==x)
  # pcm_file[temp_rows,]
  if (! is.na(mergedData$first_surgery[which(mergedData$profile_key==x)])) {
    diff_days0=pcm_file$SURVEY_DATE[temp_rows]-as.Date(mergedData$first_surgery[which(mergedData$profile_key==x)])
    surgery_diff_days[temp_rows] = diff_days0
    sel_row = temp_rows[which(abs(diff_days0)==min(abs(diff_days0),na.rm=TRUE))][1]
    first_surgery_date[sel_row] = mergedData$first_surgery[which(mergedData$profile_key==x)]
  } else {
    first_surgery_na_num = first_surgery_na_num + 1    
  }
  # cat(paste(i),"\n")
}
pcm_final = cbind(pcm_final,first_surgery_date,surgery_diff_days)

cat(paste("Number of patients in PCM with first_surgery not available =",first_surgery_na_num),"\n")
cat(paste("Number of patients in PCM with first_surgery available =",length(which(!is.na(pcm_final$first_surgery_date)))),"\n")

```

```{r,echo=FALSE}
head(pcm_final)
```

```{r, echo=FALSE}
hist(pcm_final$dx_diff_days[which(!is.na(pcm_final$dx_date))]/30,breaks=200,
     xlab="Months")

hist(pcm_final$dx_diff_days[which(!is.na(pcm_final$dx_date))]/30,breaks=200,
     xlab="Months",xlim=c(-12,12))

cat(paste("Number of patients within 30-day window =",length(which(abs(pcm_final$dx_diff_days[which(!is.na(pcm_final$dx_date))])<30))),"\n")
cat(paste("Number of patients within 60-day window =",length(which(abs(pcm_final$dx_diff_days[which(!is.na(pcm_final$dx_date))])<60))),"\n")
cat(paste("Number of patients within 90-day window =",length(which(abs(pcm_final$dx_diff_days[which(!is.na(pcm_final$dx_date))])<90))),"\n")

```


```{r,eval=FALSE}
# write.xlsx(x=pcm_final,file=paste0(dataDir,"PCM_Dates_merged_",today,".xlsx"))
```


